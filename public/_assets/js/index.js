"use strict";let resources={},rewriters={},formValues={},totalRoutesCount=0,filteredRoutesCount=0;const homePageRoutes=["/_assets/bootstrap","/_assets","/_db/:id?","/_rewriters","/_store","/_reset/:id?","/_routes"],$pageLoader=document.getElementById("page-loader"),$darkModeSwitch=document.getElementById("darkMode-switch"),$container=document.getElementById("container"),$resourcesContainer=document.getElementById("resources-container"),$dataContainer=document.getElementById("data-container"),$rewritersContainer=document.getElementById("rewriters-container"),$resourcesList=document.getElementById("resources-list"),$rewritersList=document.getElementById("rewriters-list"),$resourcesCount=document.getElementById("resources-count"),$search=document.getElementById("search"),$frameLoader=document.getElementById("iframe-loader"),$iframeData=document.getElementById("iframe-data"),$download=document.getElementById("download"),$routeModal=document.getElementById("routeModal"),$modalTitle=document.getElementById("modal-title"),$routeConfigForm=document.getElementById("route-config-form"),$routeConfig=document.getElementById("routeConfig"),$formError=document.getElementById("form-error"),$toast=document.getElementById("toast"),$resourceRedirect=document.getElementById("resource-redirect"),$iframeUrl=document.getElementById("iframe-url");let $routeBsModal,$bsToast;try{$routeBsModal=new bootstrap.Modal($routeModal),$bsToast=new bootstrap.Toast($toast,{animation:!0,delay:2e3})}catch(e){console.log(e),$routeBsModal={},$bsToast={}}function getBadges(e){return e.map((e=>`<h6 class="m-0">\n        <span class="badge bg-secondary fw-normal">${e}</span>\n      </h6>`))}function parseHTML(e){var t=document.createElement("template");return t.innerHTML=e,t.content}function findEntry(e){return Object.entries(resources).find((t=>{let[o,n]=t;return n.id==e}))||[]}function allowTabSpaces(e,t){if("Tab"==e.key){e.preventDefault();var o=t.selectionStart,n=t.selectionEnd;t.value=t.value.substring(0,o)+"\t"+t.value.substring(n),t.selectionStart=t.selectionEnd=o+1}}function showToast(e){$toast.querySelector(".toast-body").textContent=e,$bsToast?.show?.()}function parseJson(e){let t;try{t=JSON.parse(e||"")}catch{t=e?.trim()}return t}function orderRouteConfig(e){const t=JSON.parse(JSON.stringify(e)),o=Object.keys(e);o.forEach((t=>delete e[t]));return new Set(["id","description","middlewares","statusCode","delay","fetchCount","skipFetchError","mock","fetch","fetchError","store","fetchData","status","message","isImage","isError","headers","stack","response","_request","_isFile","_extension",...o]).forEach((o=>e[o]=t[o])),e}function random(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function setFormDataType(e,t){document.getElementById(`${e}-badge`).innerHTML=t}function togglePageLoader(e){e?($pageLoader.classList.add("d-block"),$pageLoader.classList.remove("d-none")):($pageLoader.classList.add("d-none"),$pageLoader.classList.remove("d-block"))}async function request(e,t){togglePageLoader(!0);const o=await window.fetch(e,t).then((e=>e.json()));return togglePageLoader(!1),o}$darkModeSwitch.checked="dark"==theme;const set=(e,t,o)=>(Object(e)!==e||(Array.isArray(t)||(t=t.toString().match(/[^.[\]]+/g)||[]),t.slice(0,-1).reduce(((e,o,n)=>Object(e[o])===e[o]?e[o]:e[o]=Math.abs(t[n+1])>>0==+t[n+1]?[]:{}),e)[t[t.length-1]]=o),e);function toggleDataContainer(e){$dataContainer.style.display=e?"block":"none"}function dragElement(e){var t;function o(o){var n={x:o.clientX-t.e.clientX,y:o.clientY-t.e.clientY};const s=Math.min(Math.max(n.x,-t.resourcesContainerWidth),t.dataContainerWidth);let r=t.dataContainerWidth-s,a=t.dataContainerWidth/100*35;$dataContainer.style.display=r<a?"none":"block",n.x=Math.min(Math.max(n.x,-t.resourcesContainerWidth),t.dataContainerWidth),e.style.left=t.offsetLeft+n.x+"px",$dataContainer.style.width=r+"px"}e.onmousedown=function(n){t={e:n,offsetLeft:e.offsetLeft,offsetTop:e.offsetTop,resourcesContainerWidth:$resourcesContainer.offsetWidth,dataContainerWidth:$dataContainer.offsetWidth},$resourcesContainer.style.pointerEvents="none",$dataContainer.style.pointerEvents="none",document.onmousemove=o,document.onmouseup=()=>{$resourcesContainer.style.pointerEvents="all",$dataContainer.style.pointerEvents="all",document.onmousemove=document.onmouseup=null}}}function toggleInfoBox(e){const t=document.getElementById(e);t.classList.contains("expanded")?hideInfoBox(t):showInfoBox(t,e)}function hideInfoBox(e){e.classList.remove("expanded"),e.removeChild(e.lastElementChild)}function showInfoBox(e,t){const[o,n]=findEntry(t),s=n?._default;e.classList.add("expanded"),e.appendChild(parseHTML(`\n    <div class="info-box position-relative overflow=hidden">\n      <div id="loader-${t.replace(/\=/g,"")}" class="backdrop d-none">\n        <div class="spinner-border" role="status">\n          <span class="visually-hidden">Loading...</span>\n        </div>\n      </div>\n      <div class="route-config p-1">${fieldSet(n,n.id)}</div>\n      <div class="actions justify-content-end p-2" style="display: ${s?"none":"flex"}">\n        <span role="button" class="px-2 pe-1 action-icon" title="reset" onclick="reset('${n.id}')"><i>Reset</i></span>\n        <span role="button" class="px-2 pe-1 action-icon" title="edit" onclick="openModal(this)" data-type="update" data-id="${n.id}"><i>Edit</i></span>\n        <span role="button" class="px-2 pe-1 action-icon" title="clone" onclick="openModal(this)" data-type="clone" data-id="${n.id}"><i>Clone</i></span>\n        <span role="button" class="px-2 pe-1 action-icon" title="refresh" onclick="refresh('${n.id}')"><i>Refresh</i></span>\n      </div>\n    </div>`))}async function reset(e){const t=document.querySelector(`.info-box #loader-${e.replace(/\=/g,"")}`);t.classList.remove("d-none"),t.classList.add("d-block");const o=await window.fetch(localhost+"/_reset/"+e).then((e=>e.json())),[n,s]=Object.entries(o)[0];resources[n]=s,toggleInfoBox(e),toggleInfoBox(e),showToast(`${n} Restored Successfully`)}async function refresh(e){const t=document.querySelector(`.info-box #loader-${e.replace(/\=/g,"")}`);t.classList.remove("d-none"),t.classList.add("d-block");const o=await window.fetch(localhost+"/_db/"+e).then((e=>e.json())),[n,s]=Object.entries(o)[0];resources[n]=s,toggleInfoBox(e),toggleInfoBox(e),showToast(`${n} Refreshed Successfully`)}function fieldSet(e,t){return Object.entries(orderRouteConfig(e)).map((e=>{let[o,n]=e;return"fetchData"===o&&Object.keys(n||{}).length?`\n      <div class="row px-3">\n          <label class="key col col-form-label p-0">\n            <button class="btn btn-white fw-semibold border-0 p-0 shadow-none" type="button" \n            data-bs-toggle="collapse" data-bs-target="#id-${t.replace(/\=/g,"")}_${o}" \n            aria-expanded="false" aria-controls="id-${t.replace(/\=/g,"")}_${o}">\n              ${o} ▸\n            </button>   \n          </label>\n          <div class="val col-12 collapse ps-0" id="id-${t.replace(/\=/g,"")}_${o}">${fieldSet(n,t)}</div>\n      </div>`:getKeyVal(o,n,t)})).join("")}function getKeyVal(e,t,o){return"_default"===e||!["mock","response"].includes(e)&&!(t+"")?.length||null==t||"_config"===e?"":!ObjectKeys.includes(e)&&Array.isArray(t)&&t.every((e=>"string"==typeof e))?["mock","response"].includes(e)||t.length?`\n      <div class="row px-3">\n        <label class="key col col-form-label p-0">${e} :</label>\n        <div class="val col d-flex flex-wrap align-items-center" style="grid-gap:.5rem">\n        ${getBadges(t).join("")}\n        </div>\n      </div>`:"":"object"==typeof t||ObjectKeys.includes(e)?["mock","response"].includes(e)||Object.keys(t).length?(t+"").trim().match(/<img(.*)>$/)?`\n      <div class="row px-3">\n        <label class="key col col-form-label p-0">${e} :</label>\n        <div class="val col">\n          <div class="img">${t}</div>\n        </div>\n      </div>`:`\n    <div class="row px-3">\n      <label class="key col col-form-label p-0 w-100" style="max-width: 100%">\n        <button class="btn btn-white fw-semibold border-0 p-0 shadow-none" type="button" \n        data-bs-toggle="collapse" data-bs-target="#id-${o.replace(/\=/g,"")}_${e}" \n        aria-expanded="false" aria-controls="id-${o.replace(/\=/g,"")}_${e}">\n          ${e} ▸\n        </button>  \n      </label>\n      <div class="val col-12 collapse p-0 mt-2 position-relative" id="id-${o.replace(/\=/g,"")}_${e}">\n        <span style="top: -1.8rem; right: 1rem;" class="position-absolute badge bg-secondary ms-4">${"object"==typeof t?"JSON":"STRING"}</span>\n        <textarea class="form-control" rows="5">${"object"==typeof t?JSON.stringify(t,null,2):t}</textarea>\n      </div>\n    </div>`:"":(t+"").indexOf("<img")>=0?`\n    <div class="row px-3">\n      <label class="key col col-form-label p-0">${e} :</label>\n      <div class="val col">\n        <div class="img">${t}</div>\n      </div>\n    </div>`:(t+"").trim().length?`\n      <div class="row px-3">\n        <label class="key col col-form-label p-0">${e} :</label>\n        <div class="val col">${t}</div>\n      </div>`:""}dragElement(document.getElementById("separator"));const ObjectKeys=["fetch","mock","fetchData","fetchError","store","_request","stack","response"];function openModal(e){formValues={},hideFormError(),$routeConfigForm.reset();const t=e.getAttribute("data-type"),o=e.getAttribute("data-id");setFormDataType("mock",""),setFormDataType("fetch",""),setFormDataType("store",""),setFormDataType("fetchData.response",""),"update"===t&&updateRoute(o),"clone"===t&&cloneRoute(o),"add"===t&&addRoute(),$routeBsModal?.show?.()}async function updateRoute(e){const t=await request(localhost+"/_db/"+e),[o,n={}]=Object.entries(t)?.[0]||[];$routeConfig.value=JSON.stringify(n),$routeConfigForm.classList.add("update-form"),$routeConfigForm.classList.remove("add-form"),$modalTitle.textContent=o,setFormValues(n,o)}function addRoute(){$routeConfig.value=JSON.stringify({routePath:$search.value}),$routeConfigForm.routePath.value=$search.value||"",formValues.routePath=$search.value||"",$routeConfigForm.classList.remove("update-form"),$routeConfigForm.classList.add("add-form"),$modalTitle.textContent="Add new Route"}async function cloneRoute(e){const t=await request(localhost+"/_db/"+e),[o,n={}]=Object.entries(t)?.[0]||[];delete n.id,$routeConfig.value=JSON.stringify(n),$routeConfigForm.classList.remove("update-form"),$routeConfigForm.classList.add("add-form"),$modalTitle.textContent=`Clone: ${o}`,setFormValues(n,o)}function setFormValues(e,t){const{id:o,description:n,statusCode:s,delay:r,fetch:a,fetchCount:l,mockFirst:i,skipFetchError:c,mock:d,store:u,middlewares:f,fetchData:m={}}=e,p=m.response;$routeConfigForm.id.value=o||"",$routeConfigForm.routePath.value=t||"",$routeConfigForm.statusCode.value=s??"",$routeConfigForm.delay.value=r??"",$routeConfigForm.fetchCount.value=l??"",$routeConfigForm.skipFetchError.checked=c+""=="true",$routeConfigForm.mockFirst.checked=i+""=="true",$routeConfigForm.description.value=n??"",$routeConfigForm.middlewares.value=f?.join(",")??"",$routeConfigForm.mock.value="object"==typeof d?JSON.stringify(d,null,8):d??"",$routeConfigForm.fetch.value="object"==typeof a?JSON.stringify(a,null,8):a??"",$routeConfigForm.store.value="object"==typeof u?JSON.stringify(u,null,8):u??"",$routeConfigForm["fetchData.response"].value="object"==typeof p?JSON.stringify(p,null,8):p??"",setFormDataType("mock","object"==typeof d?"JSON":"STRING"),setFormDataType("fetch","object"==typeof a?"JSON":"STRING"),setFormDataType("store","object"==typeof u?"JSON":"STRING"),setFormDataType("fetchData.response","object"==typeof p?"JSON":"STRING")}async function updateRouteConfig(e){const t=parseJson($routeConfig.value)||{},o=$routeConfigForm.routePath?.value?.trim();delete e.middlewares;const n={...t.fetchData||{},...e.fetchData||{}},s={[o]:{...e,...Object.keys(n)?{fetchData:n}:{}}},r=await request(localhost+"/_db/",{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(s)});Object.entries(r).forEach((e=>{let[t,o]=e;resources[t]=o})),createResourcesList(resources),$routeBsModal?.hide?.(),showToast(`${o} Updated Successfully`)}async function addNewRoute(e){const t=parseJson($routeConfig.value)||{},o=$routeConfigForm.routePath?.value?.trim(),n=$routeConfigForm.middlewares?.value?.split(",").filter(Boolean)||[],s={...t.fetchData||{},...e.fetchData||{}},r={...t,...e,...n.length?{middlewares:n}:{},...Object.keys(s)?{fetchData:s}:{}};if(delete r.routePath,delete r.id,!o?.trim()?.length){return showFormError("Please Provide Route Path"),!1}if(Object.keys(resources).find((e=>e===o?.trim()))){return showFormError("Route Path already exist. Please Provide new Route Path"),!1}const a={[o]:r},l=await request(localhost+"/_db",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(a)});Object.entries(l).forEach((e=>{let[t,o]=e;resources[t]=o})),createResourcesList(resources),$routeBsModal?.hide?.(),showToast(`${o} Added Successfully`)}function hideFormError(){$formError.style.display="none",$formError.textContent=""}function showFormError(e){$formError.style.display="block",$formError.innerHTML=e,$routeModal.querySelector(".modal-body").scrollTop=0}async function init(){$search.value="";try{resources=await request(localhost+"/_db")}catch(e){console.log(e)}try{rewriters=await request(localhost+"/_rewriters")}catch(e){console.error(e)}createResourcesList(resources),Object.entries(rewriters).length&&createRewritersList(rewriters),showToast("Resources Loaded Successfully")}function setHomePageRoutes(e){const t=Object.keys(e);t.includes("/_db")||(e["/_db"]={id:window.btoa("/_db"),description:"Get Db snapshot. Use ?_clean=true to get a refined clean Db.",_default:!0}),t.includes("/_routes")||(e["/_routes"]={id:window.btoa("/_routes"),description:"Get List of routes used.",_default:!0}),t.includes("/_store")||(e["/_store"]={id:window.btoa("/_store"),description:"Get Store values.",_default:!0})}function createResourcesList(e){homePageRoutes.forEach((t=>delete e[t]));const t=[];for($resourcesList.querySelectorAll("li.expanded").forEach((e=>t.push(e.id)));$resourcesList.lastElementChild;)$resourcesList.removeChild($resourcesList.lastElementChild);setHomePageRoutes(e),$resourcesList.innerHTML=ResourceList(e),t.forEach(toggleInfoBox),filterRoutes()}function createRewritersList(e){$rewritersList.innerHTML=Object.entries(e).map((e=>{let[t,o]=e;return`\n    <li class="nav-item w-100 mt-1 overflow-hidden d-block">\n      <div class="header d-flex align-items-center w-100" style='filter:grayscale(0.6)'">\n        <a class="nav-link py-2 px-4">\n          <span class="route-path" style="word-break:break-all">${t}</span>\n          <code class="px-2">⇢</code>\n          <span class="route-path" style="word-break:break-all">${o}</span>\n        </a>\n      </div>\n    </li>\n    `})).join(""),$rewritersContainer.style.display="block"}function ResourceList(e){return totalRoutesCount=Object.keys(e).length,setRoutesCount(totalRoutesCount),`\n    ${Object.entries(e).map((e=>ResourceItem(...e))).join("")}\n    <li id="no-resource" class="nav-item w-100 mt-2" style="display: none">\n      <span class="p-2 px-3 d-block bg-light text-center">\n        <span> No Resources Found</span>\n      </span>\n    </li>\n    <li id="add-resource" role="button" class="nav-item w-100 mt-2 d-block" data-type="add" onclick="openModal(this)">\n      <span class="nav-link p-2 px-3 me-3 text-center">\n        <span> Click here To add new Resource </span>\n      </span>\n    </li>\n    <li class="nav-item w-100 mt-2 d-block">\n      <div class="d-flex align-items-center justify-content-end">\n        <button style="margin-top:-3.6rem" \n        class="btn btn-secondary shadow-none btn-sm" \n        onclick="resetAll()"> Reset Resources</button>\n      </div>\n    </li>\n  `}function ResourceItem(e,t){const o=t._default;return`\n  <li id="${t.id}" class="nav-item w-100 mt-1 overflow-hidden" style="display: block">\n    <div class="header d-flex align-items-center w-100" style="${o?"filter:grayscale(0.6)":"filter:grayscale(0.1)"}">\n      <span role="button" class="info-icon action-icon" onclick="toggleInfoBox('${t.id}')"><span class="icon">i</span></span>  \n      <a class="nav-link py-2 pe-3 ps-0" onclick="setIframeData(this,'${e}')" type="button">\n        <span class="route-path" style="word-break:break-all">${e}</span>\n      </a>\n    </div>\n  </li>\n`}async function setIframeData(e,t){try{clearActiveLink(),e.parentNode.classList.add("active");try{$iframeData.contentWindow.document.open(),$iframeData.contentWindow.document.close()}catch{}$frameLoader.style.display="grid",$dataContainer.style.display="block",setIFrameSrc(t)}catch(e){console.error(e)}}function clearActiveLink(){const e=$resourcesList.querySelectorAll("li .header");for(let t=0;t<e.length;t++)e[t].classList.remove("active")}function setIFrameSrc(e){if(e.startsWith("http"))$resourceRedirect.href=e,$iframeUrl.value=e,$iframeData.src=e,$download.href=e;else if(e?.trim().length){let t=e.split("/").map((e=>e.indexOf(":")>=0?e.indexOf("?")>=0?"":random(1,100):e)).join("/");t=t.replace(/\/$/gi,"");const o=localhost+t;$resourceRedirect.href=o,$iframeUrl.value=o,$iframeData.src=o,$download.href=o}else $resourceRedirect.href=localhost,$iframeUrl.value=localhost,$iframeData.src="",$download.href=""}function filterRoutes(){let e,t,o,n;for(e=$search.value.toUpperCase(),t=$resourcesList.querySelectorAll(".route-path"),filteredRoutesCount=0,o=0;o<t.length;o++)n=t[o].textContent||t[o].innerText,n.toUpperCase().indexOf(e)>-1?(t[o].parentNode.parentNode.parentNode.style.display="block",filteredRoutesCount++):t[o].parentNode.parentNode.parentNode.style.display="none";setRoutesCount(totalRoutesCount,filteredRoutesCount,e),showNoResource(!filteredRoutesCount)}function setRoutesCount(e,t,o){const n=o?.length?`${t} / ${e}`:e;$resourcesCount.innerHTML=n}function showNoResource(e){document.getElementById("no-resource").style.display=e?"block":"none"}async function resetAll(){resources=await request(localhost+"/_reset"),showToast("Routes Restored Successfully"),createResourcesList(resources)}function setIframeSource(e,t){if(13===e||"Enter"===e){try{$iframeData.contentWindow.document.open(),$iframeData.contentWindow.document.close()}catch{}$frameLoader.style.display="grid",$iframeData.src=t}$resourceRedirect.href=t,$download.href=t}init(),$iframeUrl.addEventListener("keyup",(function(e){let t;void 0!==e.key?t=e.key:void 0!==e.keyIdentifier?t=e.keyIdentifier:void 0!==e.keyCode&&(t=e.keyCode),setIframeSource(t,e.target.value)}));const scrollContainer=document.querySelector("#resources-container main");scrollContainer.addEventListener("scroll",(e=>{const t=scrollContainer.querySelector("nav");scrollContainer.scrollTop>0?t.style.boxShadow="0 8px 10px -11px #212121":t.style.boxShadow="none"}));const modalTextControls=document.querySelectorAll("#route-config-form .form-control"),modalSwitchControls=document.querySelectorAll("#route-config-form .form-check-input");modalTextControls.forEach((e=>{e.addEventListener("input",(e=>{let{target:t}=e;if(["mock","fetch","store","fetchData.response"].includes(t.name)){let e="JSON";try{const o=JSON.parse(t.value);set(formValues,t.name,o),e="JSON"}catch(o){const n=t.value;set(formValues,t.name,n),e="STRING"}setFormDataType(t.name,e)}else{const e=t.value;set(formValues,t.name,e)}}))})),modalSwitchControls.forEach((e=>{e.addEventListener("click",(e=>{let{target:t}=e;const o=t.value;set(formValues,t.name,o)}))})),$routeConfigForm.addEventListener("submit",(function(e){if(e.preventDefault(),!Object.keys(formValues).length)return $routeBsModal?.hide?.(),showToast("No Changes");const t=$routeConfigForm.id?.value?.trim(),o={_config:!0,...formValues,id:t};o.id?updateRouteConfig(o):addNewRoute(o)})),$darkModeSwitch.addEventListener("click",(function(e){e.target.checked?(localStorage.setItem("theme","dark"),document.getElementsByTagName("html")[0].dataset.theme="dark"):(localStorage.removeItem("theme"),document.getElementsByTagName("html")[0].dataset.theme="")}));